console.log("wltao-orderAjaxShip js running...");KISSY.add("wltao-orderAjaxShip",function(g,b){var c=$;var n=c(".order-info"),h=n.size(),l={},e=[];var j=function(f){var p=f.find("[data-a-popover]").attr("data-a-popover");p=p.split("Phone:");p=$.trim(p[1].replace(/-/g,"")).substr(2,8);var o=window.Wla_wltao.wltal_shipphone?window.Wla_wltao.wltal_shipphone[p]:null;o=o!=undefined?o.companyid:"";return o};var d=function(){var f,p,u,t,o,w,s,v,x,r,q;for(r=0;r<h;r++){orderInfo_div=n.eq(r);f=orderInfo_div.siblings(".shipment");if(f.find(".track-package-button").size()<=0){continue}v=c.trim(orderInfo_div.find(".a-col-right .a-color-secondary ").eq(1).text());l[v]=[];x=j(orderInfo_div);w=f.size();for(q=0;q<w;q++){p=f.eq(q),u=p.find(".track-package-button a");if(u.size()<=0){continue}t=u.attr("href"),s=t.split("orderingShipmentId=")[1].split("&")[0],o=t.indexOf("/")>-1?true:false;l[v][s]={trackBtnId:u.attr("id"),isShipped:o,shipLink:t,transComp:x}}}};var a=function(q){if(c.isEmptyObject(l)){return false}var r=function(s){var y=s.replace(/<[^>]+>/g,""),x,t,w,v;var u=y.split("Tracking #:");if(u.length>1){u=c.trim(u[1]);u=u.split(" ");x=c.trim(u[0])}u=y.split("Carrier:");if(u.length>1){u=c.trim(u[1]);u=u.split(" ");t=c.trim(u[0])}u=y.split("Order #:");if(u.length>1){u=c.trim(u[1]);u=u.split(" ");w=c.trim(u[0])}u=s.split("orderingShipmentId=");if(u.length>1){u=c.trim(u[1]);u=u.split("&");v=c.trim(u[0])}return{shipNum:x,shipComp:t,orderId:w,shipmentId:v}};var f,p,o;for(o in l){for(p in l[o]){f=l[o][p];if(!f.isShipped){continue}c.ajax({url:f.shipLink,success:function(s){var u=r(s);var t=g.merge(l[u.orderId][u.shipmentId],u);typeof q==="function"&&q(t);if(e[0]){for(var v in e){typeof e[v]==="function"&&e[v](t)}}},error:function(){}})}}};var k=function(){var f=["list","datail"];return f[0]};var m=function(f){typeof f==="function"&&e.push(f);return};d();var i=function(){};return g.augment(i,{ajax:a,pushCall:m,callbacks:e}),i},{requires:["base"]});var _wlt_mfd_Obj_=window._wlt_mfd_Obj_||{};KISSY.use("wltao-orderAjaxShip",function(d,c){_wlt_mfd_Obj_.orderPack=new c()});console.log("wltao wltao_mfd.js running!");_wlt_mfd_Obj_=$.extend(window._wlt_mfd_Obj_,{turnOn:true,userid:wltao_funs&&wltao_funs.getUserId(),orderData:{},svrUrls:{add:"https://api.walatao.com/tp/?c=mfd&a=add",check:"https://api.walatao.com/tp/?c=mfd&a=checkOrder",upload:"https://api.walatao.com/tp/?c=mfd&a=orderShot",whitelist:"https://api.walatao.com/tp/?c=mfd&a=whitelist",uppack:"https://api.walatao.com/tp/?c=mfd&a=uppack"},tpl:{"upload-css":'<style>.wlt_ordershot_tip{width:274px;height:100px;background-color:#28b4ed;border-radius:3;font:14px tahoma,"microsoft yahei","微软雅黑";color:#fff;position:relative;z-index:9999}.wlt_ordershot_tip a{color:#fff}.wlt_ordershot_tip .wlt_ordershot_tip_l{width:60px;height:100%;line-height:100%;text-align:center;float:left}.wlt_ordershot_tip .wlt_ordershot_tip_l .wlt_ordershot_tip_icon{background:url(http://js.client.walatao.com/godimage/wlt_389_480.png) no-repeat;width:37px;height:37px;display:inline-block;margin-top:20px}.wlt_ordershot_tip .wlt_ordershot_tip_l .wlt_ordershot_tip_icon.tip_warn{background-position:-334px -180px}.wlt_ordershot_tip .wlt_ordershot_tip_l .wlt_ordershot_tip_icon.tip_ing{background-position:-334px -226px}.wlt_ordershot_tip .wlt_ordershot_tip_l .wlt_ordershot_tip_icon.tip_ok{background-position:-334px -269px}.wlt_ordershot_tip .wlt_ordershot_tip_l .wlt_ordershot_tip_icon.tip_upload{background-position:-287px -269px}.wlt_ordershot_tip .wlt_ordershot_tip_r{float:left;width:210px;height: 100%;position: relative;}.wlt_ordershot_tip .wlt_ordershot_tip_r .wlt_ordershot_tip_text{margin:22px 3px 12px}.wlt_ordershot_tip .wlt_ordershot_tip_r .wlt_ordershot_tip_btns a{margin:0 10px;text-decoration: underline;}.wlt_ordershot_tip .wlt_ordershot_tip_r .wlt_ordershot_tip_btns{position: absolute;bottom: 15px;left: 20px;}.wlt_ordershot_tip .wlt_ordershot_tip_cls{right:5px;position:absolute;font-style:normal;text-decoration:none;z-index:9999;}</style>',"upload-html":'<div class="wlt_ordershot_tip" id="wlt_ordershot_tip"><a href="javascript:void(0);" class="wlt_ordershot_tip_cls" id="wlt_ordershot_tip_cls"><i>x</i></a><div class="wlt_ordershot_tip_l"><i class="wlt_ordershot_tip_icon tip_warn" id="wlt_ordershot_tip_icon"></i></div><div class="wlt_ordershot_tip_r"><div class="wlt_ordershot_tip_text" id="wlt_ordershot_tip_text"></div><div class="wlt_ordershot_tip_btns" id="wlt_ordershot_tip_btns"></div></div></div>',ele:{confirm:{text:"确定上传订单截图？",icon:"tip_upload",btn:["确定","取消"]},uploading:{text:"正在上传...",icon:"tip_ing"},ok:{text:"上传成功！",icon:"tip_ok",btn:["查看截图","我的密封代"]},goon_warn:{text:"发现还有未发货商品，是否继续？（建议全部发货后再截图）",icon:"tip_warn",btn:["确定","取消"]},warn:{text:"",icon:"tip_warn",btn:["确定","取消"]}},"shot-link":'<style>.wlt_ordershot_link{width:250px;height:30px;background-color:#c3cfd4;border-radius:3;font:13px tahoma,"microsoft yahei","微软雅黑";color:#fff;position:relative;z-index:9999}.wlt_ordershot_link .wlt_ordershot_link_text{margin:0 10px 0 20px;line-height:30px;float:left}.wlt_ordershot_link a{color:#ff0;margin:0 3px}.wlt_ordershot_link .wlt_ordershot_link_cam i{background:url(http://js.client.walatao.com/godimage/wlt_389_480.png) no-repeat;background-position:-337px -142px;display:inline-block;width:30px;height:28px}</style><div class="wlt_ordershot_link" id="wlt_ordershot_link"><div class="wlt_ordershot_link_text" id="wlt_ordershot_link_text">未有商品发货，暂不可截图</div><div class="wlt_ordershot_link_cam" id="wlt_ordershot_link_cam"><a href="javascript:void(0);"><i></i></a></div></div>',"mfd-link":'<style type="text/css">.wlt_order_mfd_tip,.wlt_order_mfd_link{font-size:14px;font-family:"microsoft yahei"}.wlt_order_mfd_link .clearfix:after{visibility:hidden;font-size:0;content:" ";clear:both;height:0}.wlt_order_mfd_tip.mfdTip p{margin:0 0 3px 0;}.wlt_order_mfd_tip{width:340px;height:120px;background:#18b4ed;padding:15px;color:#fff;border-radius:3px;position:absolute;left:510px;bottom:55px;display:none}.wlt_order_mfd_tip.mfdIntro{left:475px;height:90px;bottom:65px;width:100px}.wlt_order_mfd_tip.mfdIntro a{color:#fff;text-decoration:none}.wlt_order_mfd_tip.mfdIntro a:hover{color:#fff100;text-decoration:underline;}.wlt_order_mfd_tip.mfdIntro i{margin:-15px  -6px 0 0;float:right}.wlt_order_mfd_tip .arrow{width:16px;height:16px;background:#18b4ed;transform:rotate(-45deg);position:absolute;left:80px;bottom:-8px}.wlt_order_mfd_tip.mfdIntro .arrow{left:45px}.wlt_order_mfd_link{background:#c3cfd4;width:140px;color:#fff;font-size:16px;height:30px;line-height:30px;margin-top:20px;border-radius:3px;position:absolute;left:480px;top:0}.wlt_order_mfd_link span,.wlt_order_mfd_link .wlt_order_mfd_cam{float:left}.wlt_order_mfd_link span{margin:0 20px}.wlt_order_mfd_link .wlt_order_mfd_cam{background:url(http://js.client.walatao.com/godimage/wlt_389_480.png) no-repeat -337px -142px;width:30px;height:28px;margin-left:10px}.wlt_order_mfd_btnloading{float:left;background:url(http://js.client.walatao.com/godimage/btn_loading.gif) no-repeat;margin-left:50px;width: 30px;height:28px;}.wlt_order_mfd_link .wlt_order_mfd_textlink{color:#fff}</style><div class="wlt_order_mfd_tip mfdIntro"><i><a href="javascript:void(0);">x</a></i><div class=tips><p><a target=_blank href="http://dai.walatao.com/index-begin.html">我是代购</a><br><a target=_blank href="http://dai.walatao.com/">我是买家</a><br><a target=_blank href="http://dai.walatao.com/">随便看看</a></p></div><div class=arrow></div></div><div class="wlt_order_mfd_tip mfdTip"><div class=tips></div><div class=arrow></div></div><div style="position:absolute;left:480px;top:0px;" class=wlt_order_mfd_status><a href="javascript:void(0);">什么是密封代？</a></div><div class=wlt_order_mfd_link><span class="clearfix" style="display:none"><a class=wlt_order_mfd_textlink href="javascript: void(0);">添加到密封代</a></span><i class="wlt_order_mfd_btnloading clearfix"></i><a class="wlt_order_mfd_cam clearfix" href="#" style="display:none" target="_blank"></a></div>',"shot-tip":"<p>为了保证您的截图信息齐全，请待商品发货后再截图</p>","support-tip":'<p style="margin-bottom: 10px;">密封代暂只支持使用以下转运公司的订单：</p>1.转运四方; 2.转运邦; 3.美速通; 4.笨鸟快递</p></p>5.立夫转运; 6.海淘1号仓; 7.芒果速递; 8.海购丰运</p></p></p>9.易客满; 10.中邮海外购;</p>'},post:function(a,b,c){$.post(a,b,function(d){typeof c==="function"&&c(d)});return false},reqGet:function(a,b,c){$.get(a,b,function(d){typeof c==="function"&&c(d)});return false},getQuery:function(a){return typeof wltao_getQueryString==="function"?wltao_getQueryString(a):(function(b){var c=new RegExp("(^|&)"+b+"=([^&]*)(&|$)","i");var d=window.location.search.substr(1).match(c);if(d!=null){return unescape(d[2])}return null})(a)},isSupport:function(){var a=["www.amazon.com"];return $.inArray(location.host,a)>-1},init:function(){var h=this;if(!_wlt_mfd_Obj_.turnOn){return false}var g=function(l){var j={January:1,February:2,March:3,April:4,May:5,June:6,July:7,August:8,September:9,October:10,November:11,December:12};var i=l.split(" "),k=j[i[0]]?j[i[0]]:(new Date().getMonth()+1);i=i[2]+"-"+k+"-"+i[1].replace(",","");return Math.floor(new Date(i+" 00:00:00").getTime()/1000)};var b=".track-package-button",d=$(b);var e=function(k){if(!k){return false}var q="rgb(216, 221, 230)",o="rgb(240, 193, 75)";var l=k.size();var r;var j=0;var t=k.find(b);r=t.size();var s=[];for(var n=0;n<r;n++){o==$(t[n]).css("background-color")&&(j++,s.push(t[n]))}var m=j==0?0:(r>j?1:2),p=["未有商品发货","部分商品发货","商品已全部发货","商品已送达"];if(r==0){m=3}return{stat:m,stat_detail:p[m],shippedBtns:s}};var a=function(j){var k="rgb(216, 221, 230)",i="rgb(240, 193, 75)";return i==$(j).css("background-color")};var c=function(){var t=$(".order-info");if(!t.size()>0){return false}var i,l,p,o,r,s;var n=function(C,H){var I=o.eq(C),E=i.eq(C),A=l.eq(C),v=p.eq(C),u=r.eq(C),D=s.eq(C);var x="wlt_order_mfd_textlink";var y={"background-color":"#18b4ed"},z={"background-color":"#c3cfd4"},w={"text-decoration":"none",cursor:"default",color:"#888"};var F=e(t.eq(C).siblings(".shipment"));E.css(z);u.unbind().click(function(){v.show()});I.parents("span.clearfix").show();D.hide();if(H==100){I.html("正在添加...").css(w)}else{if(H==0){I.css(w);A.find(".tips").html(h.tpl["support-tip"]);E.hover(function(){$(this).siblings(".wlt_order_mfd_tip.mfdTip").show()},function(){$(this).siblings(".wlt_order_mfd_tip.mfdTip").hide()})}else{if(H==1){E.unbind("mouseenter").css(y);m(C)}else{if(H==2&&F.stat!=0){var G=t.eq(C).find(".a-link-emphasis").attr("href");I.replaceWith('<a class="'+x+'" href="'+G+'" target="_blank">去截图</a>');var B=E.unbind("mouseenter").css(y).find("a").attr("href",G).show();u.unbind().find("a").css(w).text(F.stat_detail)}else{if(H==2&&F.stat==0){u.find("a").css(w).text(F.stat_detail);I.replaceWith("去截图");E.find("a").show();A.find(".tips").html(h.tpl["shot-tip"]);E.hover(function(){$(this).siblings(".wlt_order_mfd_tip.mfdTip").show()},function(){$(this).siblings(".wlt_order_mfd_tip.mfdTip").hide()})}else{E.unbind("mouseenter").css(y).find("a").attr("href","http://dai.walatao.com/index-begin.html").attr("target","_blank").show()}}}}}return};var m=function(u,v){if(v==0){return}o.eq(u).unbind("click").click(function(){var z=$(this).attr("orderid"),y,w=h.svrUrls.add;y=encodeURIComponent(wltao_funs.toJsonStr(h.orderData[z]));n(u,100);var x={uid:h.userid,orderinfo:y};h.post(w+"&ts="+new Date().getTime(),x,function(A){if(A.errcode==0){n(u,2)}else{alert(A.msg)}});return false})};var q=function(){var A,y;$.each(t,function(D,C){var E=h.tpl["mfd-link"],F=$(C).siblings(".shipment").find(".track-package-button").size()>0?true:false;if(!F){return false}$(C).find(".a-fixed-right-grid").append(E);A=k(C);y="wlt_order_mfd_textlink_"+D;$(".wlt_order_mfd_textlink").eq(D).attr("id",y).attr("orderid",A)});i=$(".wlt_order_mfd_link");l=$(".wlt_order_mfd_tip.mfdTip");p=$(".wlt_order_mfd_tip.mfdIntro");o=$(".wlt_order_mfd_textlink");r=$(".wlt_order_mfd_status");s=$(".wlt_order_mfd_btnloading");p.find("a").click(function(){$(this).parents(".mfdIntro").hide()});var v=$(".wlt_order_mfd_textlink").size();var z=h.svrUrls.check,x,u,B;var w=function(C){B=$("#"+C.trackBtnId).parents(".shipment").siblings(".order-info").eq(0);u=$(".order-info").index(B);x=C.orderId;h.reqGet(z,{uid:h.userid,oid:x,idx:u,transComp:C.transComp,shipComp:C.shipComp},function(E){if(E.errcode==0){var F=E.data.mfd_stat,D=E.data.idx;n(D,F);m(D,F)}else{n(D,9998);console.log("查询失败，订单号：".oid)}})};h.orderPack.pushCall(w);h.orderPack.ajax()};var j=$(b).parents(".shipment").length-1;var k=function(E){var u=$(E).siblings(".shipment");var x=u.find(".track-package-button").size()>0?true:false;var G=$.trim($(E).find(".a-col-right .a-color-secondary ").eq(1).text()),I=u.find(".a-button-input").size(),z=$.trim($(E).eq(0).find(".a-col-left .a-color-secondary").eq(1).text()),w=x?u.size():1;h.orderData[G]={ord_ordertime:g(z),ord_orderid:G,ord_dg_uid:h.userid,ord_addtime:Math.floor(new Date().getTime()/1000),ord_pronum:I,ord_packnum:w,ord_proinfo:[],ord_packinfo:[],ord_shipnum:[]};var y,B,J,v,F,H;for(var A=0;A<w;A++){y=$(u[A]);B=y.find(".a-spacing-top-medium .a-spacing-none").size()+y.find(".a-spacing-top-medium .a-spacing-base").size();H=[];for(var D=0;D<B;D++){J=$.trim(y.find(".a-fixed-right-grid-col .a-fixed-left-grid").eq(D).find(".a-col-right .a-row .a-link-normal").eq(0).text());var C=y.find(".a-fixed-right-grid-col .a-fixed-left-grid").eq(D).find(".a-col-left .a-link-normal");F=document.location.origin+C.eq(0).attr("href");v=C.find("img").eq(0).attr("src");H.push({title:J,prodpic:v,prodlink:F})}h.orderData[G].ord_packinfo.push({packid:j--,proinfo:H})}return G};q()};var f=function(){var x=$("#orderDetails");if(!x.size()>0){return false}var n=h.getQuery("orderID");var r=$(".shipment");var D=e(r),s=D?D.stat:3;var z={"1":"发现还有未发货商品，是否继续？（建议全部发货后再截图）","2":"确定上传订单截图？"};var C="#wlt_ordershot_link",w="#wlt_ordershot_link_text",u="#wlt_ordershot_link_cam";var p=function(){x.find("h1").eq(0).append(h.tpl["shot-link"]);B();return};var B=function(){if(s==1||s==2){$(C).css("background-color","#18b4ed").css("width","420px");$(w).html('截图并上传至<a href="http://dai.walatao.com/my.html" target="_blank" class="wlt_ordershot_link_mfd">密封代</a>（价格及收货人姓名会被自动抹去）');$(u).unbind("click").click(t)}else{if(s==3){$(C).hide()}else{$(u).unbind("click")}}};var v,j=$("body").html();var t=function(){var F=x.height(),J=x.width();var I,E,H=130;var G=[(I=x.offset().left+1),(E=x.offset().top+H),J+I+2,F+E-H];o();$("body").Jcrop({onRelease:function(){}},function(){v=this;v.disable();v.animateTo(G);var K=[G[0]+(G[2]-G[0])/2,G[1]+(G[3]-G[1])/2];l("confirm",{msg:z[s]},K)})};var y="";var k=function(){if(y){return y}var I,H,F;var E=x.clone(),G=$("head").clone();E.children(".a-section.a-spacing-large").eq(0).remove();E.children(".a-row.a-spacing-large").eq(0).remove();E.children("h1").eq(0).remove();H=E.html().replace(/\s+/g," ").replace(/[\r\n]/g,"");G.children("script").remove();head=G.html().replace(/\s+/g," ").replace(/[\r\n]/g,"");y="<html><head>"+head+'</head><body><div id="a-page"><div id="orderDetails">'+H+"</div></div></body></html>";return y};var o=function(){var F=[".displayAddressUL li:first",".a-col-right .a-span-last",".a-color-price"];var E=x.find(F.join(",")),G={cssText:"color:#f00 !important","background-color":"#f00"};E.css(G)};var i=function(){l("uploading");var E=encodeURIComponent(k());h.post(h.svrUrls.upload,{uid:wltao_funs&&wltao_funs.getUserId(),orderid:n,dom:E},function(F){if(F.errcode==0){l("ok",{link:F.data.pic})}else{var G=F.msg;F.errcode!=1&&l("warn",{msg:G});F.errcode==1&&l("warn",{msg:G,link:"https://www.amazon.com/gp/css/order-history/ref=nav_youraccount_orders_first"})}});return false};var q=function(){v.destroy();document.body=document.createElement("body");$("body").append(j)};var l=function(L,P,J){var R=h.tpl.ele[L],K=$(".jcrop-holder");var N=$("#wlt_ordershot_tip").size();if(!K.size()||!R){return false}if(!N){K.append(h.tpl["upload-css"]+h.tpl["upload-html"]);N=$("#wlt_ordershot_tip");J&&N.css("left",J[0]-N.width()/2+"px").css("top",J[1]-N.height()/2+"px");$("#wlt_ordershot_tip_cls").unbind().click(q)}var G=$("#wlt_ordershot_tip_text"),M=$("#wlt_ordershot_tip_icon"),I=$("#wlt_ordershot_tip_btns"),O=P&&P.msg?P.msg:R.text,Q=P&&P.icon?P.icon:R.icon;G.html(O);M.attr("class","wlt_ordershot_tip_icon "+Q);I.html("");var E=P&&P.btn?P.btn:R.btn;if($.isArray(E)&&E[0]){for(var H=0;H<E.length;H++){I.append('<a href="javascript:void(0);">'+E[H]+"</a>")}}var F=P&&P.link?P.link:false;A(L,I,F);return};var A=function(G,F,E){var H=F.find("a");if("confirm"==G||"goon_warn"==G){H&&H.unbind();H.eq(0)&&H.eq(0).click(i);H.eq(1)&&H.eq(1).click(q)}if("warn"==G){H&&H.unbind().click(q);E&&H.eq(0).unbind().attr("href",E).attr("target","_blank")}if("ok"==G){H&&H.unbind().attr("target","_blank");H.eq(0)&&H.eq(0).attr("href",E?E:"#");H.eq(1)&&H.eq(1).attr("href","http://dai.walatao.com/my.html")}};var m=function(){var G=r.size(),H,K,M,F=[],I,L;var N=0;for(var J=0;J<G;J++){H=r[J];K=$(H).find(b);if(a(K)){M=K.find("a").attr("href")+"&__refer=api.mfd";$.ajax({url:M,success:function(O){var Q=O.replace(/<[^>]+>/g,"");var P=Q.split("Tracking #:");if(P.length>1){P=$.trim(P[1]);P=P.split(" ");I=$.trim(P[0])}P=Q.split("Carrier:");if(P.length>1){P=$.trim(P[1]);P=P.split(" ");L=$.trim(P[0])}F[N]={shipnum:I,shipcomp:L};N++;console.log("--------update request---------")}})}F.push({})}var E=setInterval(function(){console.log("-----update ShipInfo----idx:---"+N+"---shipCtn:---"+G+"-----");if(N>=G){h.post(h.svrUrls.uppack,{uid:wltao_funs.getUserId(),orderid:n,packinfo:encodeURIComponent(wltao_funs.toJsonStr(F))},function(O){});clearInterval(E)}},1500);setTimeout(function(){clearInterval(E)},20000)};m();p()};(function(){if(!h.isSupport()){return false}h.reqGet(h.svrUrls.whitelist,{uid:h.userid},function(i){if(i.iswhite){c();f()}else{console.log("非密封代白名单用户")}})})()}});