$(function() {
	$(".job_del").bind("click", function() {
		var _this = $(this);
		var positionId = _this.parents("li").attr("data-id");
		var resubmitToken = $("#resubmitToken").val();
		if (confirm("确定要删除该职位吗？")) {
			$.ajax({
				url: ctx + "Company/positionDelete",
				data: {
					positionId: positionId,
					resubmitToken: resubmitToken
				},
				dataType: "json"
			}).done(function(result) {
				$("#resubmitToken").val(result.resubmitToken);
				if (result.success) {
					if ($(".my_jobs li").length == 1) {
						top.location.reload()
					} else {
						$("#positionNumber").text($("#positionNumber").text() - 1);
						_this.parents("li").remove()
					}
				} else {
					alert(result.msg)
				}
			})
		} else {
			return false
		}
	});
	$(".job_offline").click(function(e) {
		e.preventDefault();
		var _this = $(this);
		var id = _this.parents("li").attr("data-id");
		var resubmitToken = $("#resubmitToken").val();
		if (confirm("确定要将该职位下线吗？下线后该职位将不再展现给用户")) {
			$.ajax({
				url: ctx + "Company/positionOffline",
				data: {
					id: id,
					resubmitToken: resubmitToken
				},
				dataType: "json"
			}).done(function(result) {
				$("#resubmitToken").val(result.resubmitToken);
				if (result.success) {
					if ($(".my_jobs li").length == 1) {
						top.location.reload()
					} else {
						$("#positionNumber").text($("#positionNumber").text() - 1);
						_this.parents("li").remove()
					}
				} else {
					alert("下线失败")
				}
			})
		} else {
			return false
		}
	});
	$(".links .job_refresh").bind("click", function(e) {
		e.preventDefault();
		var _this = $(this);
		var id = _this.parents("li").attr("data-id");
		$.ajax({
			url: ctx + "Company/positionRefresh",
			data: {
				id: id
			},
			dataType: "json"
		}).done(function(result) {
			if (result.success) {
				_this.parent(".links").siblings("div.c9").html("刷新时间：刚刚");
				_this.html("已刷新<span>每个职位7天内只能刷新一次</span><i>刷新成功</i>").attr("class", "job_refreshed");
				_this.children("i").fadeIn(200).delay(1500).fadeOut(200);
				_this.unbind("click")
			} else {
				alert(result.msg)
			}
		})
	});
	$(".links").on("mouseenter", ".job_refreshed", function() {
		$("span", this).fadeIn(200)
	});
	$("#filter_btn").bind("click", function() {
		if ($(this).attr("class") == "show") {
			$("#filterStatus").val(0);
			$(this).removeClass("show").children("em").removeClass("transform");
			$(".filter_options").slideUp(200).prev(".filter_actions").removeClass("btm")
		} else {
			$("#filterStatus").val(1);
			$(this).addClass("show").children("em").addClass("transform");
			$(".filter_options").slideDown(200).prev(".filter_actions").addClass("btm")
		}
	});
	$(".filter_actions .checkbox input").bind("click", function() {
		if ($(this).attr("checked")) {
			$(this).removeAttr("checked");
			$(this).siblings("i").fadeOut(200);
			$(".resumeLists li").each(function() {
				$(".checkbox i", this).fadeOut(200);
				$(".checkbox input", this).removeAttr("checked")
			})
		} else {
			$(this).attr("checked", "checked");
			$(this).siblings("i").fadeIn(200);
			$(".resumeLists li").each(function() {
				$(".checkbox i", this).fadeIn(200);
				$(".checkbox input", this).attr("checked", "checked")
			})
		}
		return false
	});
	$(".resumeLists").on("click", ".checkbox input", function() {
		if ($(this).attr("checked")) {
			$(this).removeAttr("checked");
			$(this).siblings("i").fadeOut(200);
			var check = false;
			$(".resumeLists li").each(function() {
				if ($(".checkbox input", this).attr("checked")) {
					check = true
				}
			});
			if (!check) {
				$(".filter_actions .checkbox input").removeAttr("checked").siblings("i").fadeOut(200)
			}
		} else {
			$(this).attr("checked", "checked");
			$(this).siblings("i").fadeIn(200)
		}
		return false
	});
	$("#filterForm").on("mouseenter", ".checkbox", function() {
		if (!$(this).children("input").attr("checked")) {
			$("i", this).stop(true, true).fadeIn(200)
		}
	});
	$("#filterForm").on("mouseleave", ".checkbox", function() {
		if (!$(this).children("input").attr("checked")) {
			$("i", this).stop(true, true).fadeOut(200)
		}
	});
	$(".resumeLists").on("click", ".job_verify", function() {
		if ($.cookie("verifyPos") == 1) {
			var id = $(this).parents("li").attr("data-id");
			var resubmitToken = $("#resubmitToken").val();
			verifyPositions(id, 1, "", resubmitToken)
		} else {
			var obj = $(this).parent();
			$(".company_center_content").find(".check_popbox").remove();
			$("#checkPopBox").clone().appendTo(obj);
			obj.children("#checkPopBox").addClass("check_popbox_verify").removeClass("dn")
		}
	});
	$(".resumeLists").on("click", ".job_verify_fail", function() {
		var obj = $(this).parent();
		$(".company_center_content").find(".check_popbox").remove();
		$("#uncheckPopBox").clone().appendTo(obj);
		obj.children("#uncheckPopBox").addClass("check_popbox_unverified").removeClass("dn")
	});
	$("#verifyAll").bind("click", function() {
		var positionIds = new Array();
		var resubmitToken = $("#resubmitToken").val();
		$(".resumeLists li").each(function() {
			if ($(this).find('input[type="checkbox"]').attr("checked")) {
				positionIds.push($(this).attr("data-id"))
			}
		});
		positionIds = positionIds.join(",");
		if (positionIds == "") {
			alert("请选择要标记的职位");
			return false
		} else {
			if ($.cookie("verifyPos") == 1) {
				verifyPositions(positionIds, 1, "", resubmitToken)
			} else {
				var obj = $(this).parent();
				$(".company_center_content").find(".check_popbox").remove();
				$("#checkPopBox").clone().appendTo(obj);
				obj.children("#checkPopBox").addClass("check_popbox_verifyAll").removeClass("dn")
			}
		}
	});
	$("#failAll").bind("click", function() {
		var positionIds = new Array();
		$(".resumeLists li").each(function() {
			if ($(this).find('input[type="checkbox"]').attr("checked")) {
				positionIds.push($(this).attr("data-id"))
			}
		});
		positionIds = positionIds.join(",");
		if (positionIds == "") {
			alert("请选择要标记的职位");
			return false
		} else {
			var obj = $(this).parent();
			$(".company_center_content").find(".check_popbox").remove();
			$("#uncheckPopBox").clone().appendTo(obj);
			obj.children("#uncheckPopBox").addClass("check_popbox_unverifiedAll").removeClass("dn")
		}
	});
	$("#filterForm").on("click", ".check_popbox .close,.check_popbox .cancel", function() {
		$(this).parents(".check_popbox").remove()
	});
	$(".filter_actions").on("click", "#checkPopBox .btn_confirm", function() {
		var positionIds = new Array();
		var resubmitToken = $("#resubmitToken").val();
		$(".resumeLists li").each(function() {
			if ($(this).find('input[type="checkbox"]').attr("checked")) {
				positionIds.push($(this).attr("data-id"))
			}
		});
		positionIds = positionIds.join(",");
		verifyPositions(positionIds, 1, "", resubmitToken)
	});
	$(".resumeLists").on("click", "#checkPopBox .btn_confirm", function() {
		var resubmitToken = $("#resubmitToken").val();
		var id = $(this).parents("li").attr("data-id");
		verifyPositions(id, 1, "", resubmitToken)
	});
	$(".filter_actions").on("click", "#uncheckPopBox .btn_confirm", function() {
		var positionIds = new Array();
		var resubmitToken = $("#resubmitToken").val();
		var reason = $(this).parent().find('input[type="radio"]:checked').val();
		$(".resumeLists li").each(function() {
			if ($(this).find('input[type="checkbox"]').attr("checked")) {
				positionIds.push($(this).attr("data-id"))
			}
		});
		positionIds = positionIds.join(",");
		if (reason) {
			verifyPositions(positionIds, 3, reason, resubmitToken)
		} else {
			alert("请选择不通过审核的原因")
		}
	});
	$(".resumeLists").on("click", "#uncheckPopBox .btn_confirm", function() {
		var resubmitToken = $("#resubmitToken").val();
		var id = $(this).parents("li").attr("data-id");
		var reason = $(this).parent().find('input[type="radio"]:checked').val();
		if (reason) {
			verifyPositions(id, 3, reason, resubmitToken)
		} else {
			alert("请选择不通过审核的原因")
		}
	});
	$(".filter_actions").on("click", ".check_popbox .checkbox input", function() {
		if ($(this).attr("checked")) {
			$(this).removeAttr("checked");
			$(this).siblings("i").fadeOut(200)
		} else {
			$(this).attr("checked", "checked");
			$(this).siblings("i").fadeIn(200)
		}
		return false
	});
	$("#job_preview_btmbar").on("click", ".btn_verify", function() {
		if ($.cookie("verifyPos") && $.cookie("verifyPos") == 1) {
			var id = $("#positionId").val();
			var resubmitToken = $("#resubmitToken").val();
			verifyPositions(id, 1, "", resubmitToken)
		} else {
			$(this).siblings("#uncheckPopBox").removeClass("check_popbox_unverified").addClass("dn");
			$(this).siblings("#checkPopBox").addClass("check_popbox_verify").removeClass("dn")
		}
	});
	$("#job_preview_btmbar").on("click", "#checkPopBox .btn_confirm", function() {
		var resubmitToken = $("#resubmitToken").val();
		var id = $("#positionId").val();
		verifyPositions(id, 1, "", resubmitToken)
	});
	$("#job_preview_btmbar").on("click", ".btn_unverify", function() {
		$(this).siblings("#checkPopBox").removeClass("check_popbox_verify").addClass("dn");
		$(this).siblings("#uncheckPopBox").addClass("check_popbox_unverified").removeClass("dn")
	});
	$("#job_preview_btmbar").on("click", "#uncheckPopBox .btn_confirm", function() {
		var resubmitToken = $("#resubmitToken").val();
		var id = $("#positionId").val();
		var reason = $(this).parent().find('input[type="radio"]:checked').val();
		if (reason) {
			verifyPositions(id, 3, reason, resubmitToken)
		} else {
			alert("请选择不通过审核的原因")
		}
	});
	$("#job_preview_btmbar .check_popbox .close,#job_preview_btmbar .check_popbox .cancel").click(function() {
		$(this).parents(".check_popbox").addClass("dn")
	});
	$("#job_preview_btmbar .checkbox input").click(function() {
		if ($(this).attr("checked")) {
			$(this).removeAttr("checked");
			$(this).siblings("i").fadeOut(200)
		} else {
			$(this).attr("checked", "checked");
			$(this).siblings("i").fadeIn(200)
		}
		return false
	});
	$("#job_preview_btmbar .checkbox").hover(function() {
		if (!$(this).children("input").attr("checked")) {
			$("i", this).stop(true, true).fadeIn(200)
		}
	}, function() {
		if (!$(this).children("input").attr("checked")) {
			$("i", this).stop(true, true).fadeOut(200)
		}
	})
});

function verifyPositions(ids, type, reason, resubmitToken) {
	if (type == 1 && $("#checkPopBox .checkbox input").attr("checked")) {
		$.cookie("verifyPos", 1, {
			expired: 30
		})
	}
	$.ajax({
		type: "POST",
		url: ctx + "/corpPosition/verifyPositions.json",
		data: {
			ids: ids,
			type: type,
			reason: reason,
			resubmitToken: resubmitToken
		},
		dataType: "json"
	}).done(function(result) {
		$("#resubmitToken").val(result.resubmitToken);
		if (result.success) {
			top.location.href = top.location.href
		} else {
			alert(result.msg)
		}
	})
};