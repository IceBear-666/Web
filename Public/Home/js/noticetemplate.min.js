(function() {
	$(function() {
		var upTemId = -1;
		var isLeave = true;
		var addFlag = false;
		var tmpIdt = -1;
		var flag = -1;
		var tmpIds = -1;
		beforeLeave();

		function beforeLeave() {
			window.onbeforeunload = function() {
				if (isLeave) {
					return
				} else {
					return "内容还未保存，确认离开该页面吗？ "
				}
			}
		}
		$(".set_default").bind("click", function() {
			var id = $(this).data("temid");
			if ($("#noticeType").val() == 0) {
				var href = "/User/setDefaultInterviewTemplate";
				var obj = {
					id: id
				};
				callAjax(href, obj)
			} else {
				var href = "/User/setDefaultRefuseTemplate";
				var obj = {
					id: id
				};
				callAjax(href, obj)
			}
		});
		$(".del_label .checkbox input").siblings("i").fadeOut();
		$(".del_label .checkbox input").bind("click", function() {
			if ($(this).attr("checked")) {
				$(this).removeAttr("checked");
				$(this).siblings("i").fadeOut(200)
			} else {
				$(this).attr("checked", "checked");
				$(this).siblings("i").fadeIn(200)
			}
			return false
		});
		$(".del_know").bind("click", function() {
			$("#cboxClose").click()
		});
		$(".del_sure").bind("click", function() {
			if ($("#noticeType").val() == 0) {
				if ($(".del_label .checkbox input").attr("checked")) {
					closenlraf(true, "interviewCookie")
				}
				var href = "/User/deleteTemplate";
				var obj = {
					id: upTemId
				};
				callAjax(href, obj)
			} else {
				if ($(".del_label .checkbox input").attr("checked")) {
					closenlraf(true, "unqualifyCookie")
				}
				var href = "/User/deleteTemplate";
				var obj = {
					id: upTemId
				};
				callAjax(href, obj)
			}
			$("#cboxClose").click()
		});
		$("#confirm_leave").bind("click", function() {
			$("#cboxClose").click();
			if (addFlag) {
				$("#addTmp").removeClass("grey")
			}
			var formId = $(".notice_dd form").eq(0).attr("id");
			if (formId == "addForm") {
				if (tmpIds != -1) {
					$(".template_list").each(function(index) {
						if ($(this).data("temid") == flag) {
							$("#addForm").remove();
							var othis = $(this).find(".updateTmp");
							initUpForm(othis);
							addFlag = false;
							isLeave = false
						}
					})
				} else {}
			} else {
				if (tmpIds != -1) {
					$(".template_list").each(function(index) {
						if ($(this).data("temid") == tmpIds) {
							$(this).next().remove();
							$(this).show();
							isLeave = false
						}
					});
					$(".template_list").each(function(index) {
						if ($(this).data("temid") == flag) {
							var othis = $(this).find(".updateTmp");
							initUpForm(othis);
							addFlag = false;
							isLeave = false
						}
					})
				} else {
					$(".template_list").each(function(index) {
						if ($(this).data("temid") == flag) {
							$(this).next().remove();
							$(this).show();
							console.log(tmpIds + "--tmpIds");
							var othis = $(this).find(".updateTmp");
							initAdd();
							isLeave = false
						}
					})
				}
			}
		});

		function initUpForm(othis) {
			isLeave = false;
			var _this = $(othis);
			var tmpName = $(othis).parent().parent().find("strong").text();
			if ($("#noticeType").val() == 0) {
				var address = $(othis).parent().parent().parent().next().find("span").eq(0).text();
				var linkman = $(othis).parent().parent().parent().next().find("span").eq(1).text();
				var mobile = $(othis).parent().parent().parent().next().find("span").eq(2).text();
				var tip = $(othis).parent().parent().parent().next().find("span").eq(3).html();
				tip = L.trim(tip)
			} else {
				var tip = $(othis).parent().parent().parent().next().find("span").eq(0).html();
				tip = L.trim(tip)
			}
			$("#add_template #cancel").text("取消修改");
			$(othis).parent().parent().parent().parent().hide().after($("#add_template").html());
			$(othis).parent().parent().parent().parent().next().attr("id", "updateForm");
			validUpForm();
			$("#tmpname").val(tmpName);
			if ($("#noticeType").val() == 0) {
				$("#site").val(address);
				$("#linkman").val(linkman);
				$("#mobile").val(mobile)
			}
			$("#tmpTip").html(tip);
			$("#updateForm #cancel").bind("click", function() {
				isLeave = true;
				$("#addTmp").removeClass("grey");
				$(this).parent().parent().parent().parent().remove();
				$(_this).parent().parent().parent().parent().show()
			})
		}
		$("#cancel_leave").bind("click", function() {
			$("#cboxClose").click();
			addFlag = false
		});

		function closenlraf(a, name) {
			if (a) {
				L.cookie(name, "true", {
					path: "/",
					expires: 30,
					domain: "c.lagou.com"
				})
			} else {
				L.cookie(name, "true", {
					path: "/",
					domain: "c.lagou.com"
				})
			}
		}
		$(".unqualified .delTmp").bind("click", function() {
			upTemId = $(this).data("temid");
			var tmpType = $(this).parent().parent().find(".set_default");
			if (tmpType.text() != "" && tmpType.text() != null) {
				if (L.cookie("unqualifyCookie") == null) {
					L.colorbox({
						inline: true,
						href: $("#deleteNormal"),
						title: "模板提示"
					})
				} else {
					closenlraf(true, "unqualifyCookie");
					var href = "/User/deleteTemplate";
					var obj = {
						id: upTemId
					};
					callAjax(href, obj)
				}
			} else {
				L.colorbox({
					inline: true,
					href: $("#deleteDefault"),
					title: "模板提示"
				})
			}
		});
		$(".interview .delTmp").bind("click", function() {
			upTemId = $(this).data("temid");
			var tmpType = $(this).parent().parent().find(".set_default");
			if (tmpType.text() != "" && tmpType.text() != null) {
				if (L.cookie("interviewCookie") == null) {
					L.colorbox({
						inline: true,
						href: $("#deleteNormal"),
						title: "模板提示"
					})
				} else {
					closenlraf(true, "interviewCookie");
					var href = "/User/deleteTemplate";
					var obj = {
						id: upTemId
					};
					callAjax(href, obj)
				}
			} else {
				L.colorbox({
					inline: true,
					href: $("#deleteDefault"),
					title: "模板提示"
				})
			}
		});
		$(".updateTmp").bind("click", function() {
			upTemId = $(this).data("temid");
			if (tmpIdt != -1) {
				tmpIds = tmpIdt
			} else {
				tmpIds = $(this).parent().parent().parent().parent().data("temid")
			}
			flag = tmpIdt = $(this).parent().parent().parent().parent().data("temid");
			if (!isLeave) {
				L.colorbox({
					inline: true,
					href: $("#templateTip"),
					title: "提示信息"
				});
				return false
			}
			isLeave = false;
			var _this = $(this);
			var tmpName = $(this).parent().parent().find("strong").text();
			if ($("#noticeType").val() == 0) {
				var address = $(this).parent().parent().parent().next().find("span").eq(0).text();
				var linkman = $(this).parent().parent().parent().next().find("span").eq(1).text();
				var mobile = $(this).parent().parent().parent().next().find("span").eq(2).text();
				var tip = $(this).parent().parent().parent().next().find("span").eq(3).text();
				tip = L.trim(tip)
			} else {
				var tip = $(this).parent().parent().parent().next().find("span").eq(0).text();
				tip = L.trim(tip)
			}
			$("#add_template #cancel").text("取消修改");
			$(this).parent().parent().parent().parent().hide().after($("#add_template").html());
			$(this).parent().parent().parent().parent().next().attr("id", "updateForm");
			validUpForm();
			placeholderFn();
			$("#tmpname").val(tmpName);
			if ($("#noticeType").val() == 0) {
				$("#site").val(address);
				$("#linkman").val(linkman);
				$("#mobile").val(mobile)
			}
			$("#tmpTip").val(tip);
			$("#updateForm .cancel").bind("click", function() {
				isLeave = true;
				addFlag = false;
				$("#addTmp").removeClass("grey");
				$(this).parent().parent().parent().parent().remove();
				$(_this).parent().parent().parent().parent().show()
			})
		});
		$("#addTmp").bind("click", function(e) {
			tmpIdt = -1;
			tmpIds = -1;
			e.stopPropagation();
			var formId = $(".notice_dd form").eq(0).attr("id");
			if (formId == "addForm") {
				return false
			}
			addFlag = true;
			if (!isLeave) {
				L.colorbox({
					inline: true,
					href: $("#templateTip"),
					title: "提示信息"
				});
				return false
			} else {
				$("#addTmp").addClass("grey")
			}
			$("#add_template #cancel").text("取消添加");
			$(".default").parent().parent().parent().parent().after($("#add_template").html());
			$(".default").parent().parent().parent().parent().next().attr("id", "addForm");
			$("html, body").animate({
				scrollTop: $("#addForm").offset().top
			});
			placeholderFn();
			validForm();
			isLeave = false;
			$("#addForm #cancel").bind("click", function() {
				isLeave = true;
				addFlag = false;
				$("#addTmp").removeClass("grey");
				$(this).parent().parent().parent().parent().remove()
			})
		});

		function initAdd() {
			tmpIdt = -1;
			tmpIds = -1;
			addFlag = true;
			$("#addTmp").addClass("grey");
			isLeave = false;
			$("#add_template #cancel").text("取消添加");
			$(".default").parent().parent().parent().parent().after($("#add_template").html());
			$(".default").parent().parent().parent().parent().next().attr("id", "addForm");
			validForm();
			placeholderFn();
			$("#addForm #cancel").bind("click", function() {
				isLeave = true;
				addFlag = false;
				$("#addTmp").removeClass("grey");
				$(this).parent().parent().parent().parent().remove()
			});
			return false
		}
		$(".template_list").hover(function() {
			$(this).find(".set_default").show()
		}, function() {
			$(this).find(".set_default").hide()
		});

		function validForm() {
			$("#addForm").validate({
				onkeyup: true,
				rules: {
					tmpname: {
						required: true,
						maxlenStr: 15
					},
					site: {
						required: false,
						maxlength: 200
					},
					linkman: {
						required: false,
						rangeLenMin: 1,
						rangeLenMax: 8
					},
					mobile: {
						required: false,
						isTelNoRequire: true,
						maxlength: 30
					},
					tmpTip: {
						required: false,
						maxlength: 500
					},
					tmpTipRefuse: {
						required: false,
						maxlength: 200
					}
				},
				messages: {
					tmpname: {
						required: "请填写模板名",
						maxlenStr: "请输入30字以内的字符"
					},
					site: {
						maxlength: "请输入200字符以内的面试地点"
					},
					linkman: {
						rangeLenMin: "请输入2-16个字符的联系人",
						rangeLenMax: "请输入2-16个字符的联系人"
					},
					mobile: {
						maxlength: "请输入30字以内的联系电话"
					},
					tmpTip: {
						maxlength: "请输入500字符以内的补充内容"
					},
					tmpTipRefuse: {
						maxlength: "请输入200字符以内的补充内容"
					}
				},
				errorPlacement: function(label, element) {
					label.appendTo($(element).parent());
					$(".c_section span.error").css("margin", "5px 0 10px 88px")
				},
				submitHandler: function(form) {
					if ($("#noticeType").val() == 0) {
						var tmpname = $(".notice_main #tmpname").val();
						var site = $(".notice_main #site").val();
						var linkman = $(".notice_main #linkman").val();
						var mobile = $(".notice_main #mobile").val();
						var tmpTip = $(".notice_main #tmpTip").val();
						var href = "/User/addInterviewTemplate";
						var obj = {
							alis: tmpname,
							content: tmpTip,
							interviewAddress: site,
							linkMan: linkman,
							linkPhone: mobile
						};
						callAjax(href, obj)
					} else {
						var tmpname = $(".notice_main #tmpname").val();
						var tmpTip = $(".notice_main #tmpTip").val();
						var href = "/User/addRefuseTemplate";
						var obj = {
							alis: tmpname,
							content: tmpTip
						};
						callAjax(href, obj)
					}
					isLeave = true
				}
			})
		}
		function validUpForm() {
			$("#updateForm").validate({
				onkeyup: true,
				rules: {
					tmpname: {
						required: true,
						maxlenStr: 15
					},
					site: {
						required: false,
						maxlength: 200
					},
					linkman: {
						required: false,
						rangeLenMin: 1,
						rangeLenMax: 8
					},
					mobile: {
						required: false,
						isTelNoRequire: true,
						maxlength: 30
					},
					tmpTip: {
						required: false,
						maxlength: 500
					},
					tmpTipRefuse: {
						required: false,
						maxlength: 200
					}
				},
				messages: {
					tmpname: {
						required: "请填写模板名",
						maxlenStr: "请输入30字以内的字符"
					},
					site: {
						maxlength: "请输入200字符以内的面试地点"
					},
					linkman: {
						rangeLenMin: "请输入2-16个字符的联系人",
						rangeLenMax: "请输入2-16个字符的联系人"
					},
					mobile: {
						maxlength: "请输入30字以内的联系电话"
					},
					tmpTip: {
						maxlength: "请输入500字符以内的补充内容"
					},
					tmpTipRefuse: {
						maxlength: "请输入200字符以内的补充内容"
					}
				},
				errorPlacement: function(label, element) {
					label.appendTo($(element).parent());
					$(".c_section span.error").css("margin", "5px 0 10px 88px")
				},
				submitHandler: function(form) {
					if ($("#noticeType").val() == 0) {
						var upId = upTemId;
						var tmpname = $(".notice_main #tmpname").val();
						var site = $(".notice_main #site").val();
						var linkman = $(".notice_main #linkman").val();
						var mobile = $(".notice_main #mobile").val();
						var tmpTip = $(".notice_main #tmpTip").val();
						var href = "/User/addInterviewTemplate";
						var obj = {
							id: upId,
							alis: tmpname,
							content: tmpTip,
							interviewAddress: site,
							linkMan: linkman,
							linkPhone: mobile
						};
						callAjax(href, obj)
					} else {
						var upId = upTemId;
						var tmpname = $(".notice_main #tmpname").val();
						var tmpTip = $(".notice_main #tmpTip").val();
						var href = "/User/addRefuseTemplate";
						var obj = {
							id: upId,
							alis: tmpname,
							content: tmpTip
						};
						callAjax(href, obj)
					}
					isLeave = true;
					addFlag = false;
					$("#addTmp").removeClass("grey")
				}
			})
		}
	});

	function callAjax(href, obj) {
		L.ajax({
			type: "POST",
			url: ctx + href,
			data: obj,
			dataType: "json"
		}).done(function(result) {
			if (result.state == "1") {
				top.location.href = top.location.href
			} else {
				alert(result.message)
			}
		})
	}
})();